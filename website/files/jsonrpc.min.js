// (c) 2011 Artyom Beilis (Tonkikh)
// Distributed under the Boost Software License, Version 1.0. (See
// accompanying file LICENSE_1_0.txt or copy at
// http://www.boost.org/LICENSE_1_0.txt)
function JsonRPC(e,t,n){if(!(this instanceof JsonRPC))return new JsonRPC(e,t,n);this.uri=e;if(typeof t!="undefined")for(var r=0;r<t.length;r++)this.addRPCMethod(t[r],r);if(typeof n!="undefined")for(var r=0;r<n.length;r++)this.addRPCMethod(n[r],null)}JsonRPC.prototype.getXHR=function(){var e;if(typeof XMLHttpRequest=="undefined"){try{e=new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{e=new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}throw new Error("No XML HTTP Rewquest support")}return e=new XMLHttpRequest,e},JsonRPC.prototype.runXHR=function(e,t,n,r){e.setRequestHeader("Content-Type","application/json");var i={id:n,method:t,params:r},s=JSON.stringify(i);e.send(s)},JsonRPC.prototype.syncCall=function(e,t,n){var r=this.getXHR();r.open("post",this.uri,!1),this.runXHR(r,e,t,n);if(r.status!=200)throw Error("Invalid response:"+r.status);if(t!=null){var i=null;try{i=JSON.parse(r.responseText)}catch(s){throw Error("Invalid JSON-RPC response")}if(i.error!=null)throw Error(i.error);return i.result}},JsonRPC.prototype.asyncCall=function(e,t,n,r,i){var s=this.getXHR();s.open("post",this.uri,!0),s.onreadystatechange=function(){if(s.readyState!=4)return;if(s.status==200)if(t!=null){var e=null;try{e=JSON.parse(s.responseText)}catch(n){i({type:"protocol",error:"invalid response"});return}e.error!=null?i({type:"response",error:e.error}):r(e.result)}else r();else i({type:"transport",error:s.status})},this.runXHR(s,e,t,n)},JsonRPC.prototype.addRPCMethod=function(e,t){var n=function(){var r=new Array;for(var i=0;i<arguments.length;i++)r[i]=arguments[i];if(n.on_result==null)return this.syncCall(e,t,r);this.asyncCall(e,t,r,n.on_result,n.on_error)};n.on_error=function(e){throw Error(e.error)},n.on_result=null,this[e]=n};
